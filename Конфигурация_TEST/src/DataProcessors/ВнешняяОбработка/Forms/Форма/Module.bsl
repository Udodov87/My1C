// Файл: Конфигурация_TEST/src/DataProcessors/ВнешняяОбработка/Forms/Форма/Module.bsl
#Region обработчикиКомандформы
&НаКлиенте
Процедура ПоказатьСообщение(Команда)
	Объект.ТекстСообщения=строка(ПолучитьКурсUSD_ЦБ());
КонецПроцедуры

#EndRegion

#Region СлужебныеПроцедурыИФункции
&НаСервере
Функция ПолучитьКурсUSD_ЦБ(Знач ДатаКурса = Неопределено) 

	Если ДатаКурса = Неопределено Тогда
		ДатаКурса = ТекущаяДатаСеанса();
	КонецЕсли;

	// Формируем строку даты для URL (DD/MM/YYYY)
	СтрДата = Формат(ДатаКурса, "ДФ=dd/MM/yyyy");
	АдресСайта = "www.cbr.ru";
	Ресурс = "/scripts/XML_daily.asp?date_req=" + СтрДата;

	HTTP = Новый HTTPСоединение(АдресСайта, 443,,,,, Новый ЗащищенноеСоединениеOpenSSL());
	Запрос = Новый HTTPЗапрос(Ресурс);
	
	Попытка
		Ответ = HTTP.Получить(Запрос);
		Если Ответ.КодСостояния <> 200 Тогда
			Возврат 0;
		КонецЕсли;
		
		// Читаем тело ответа, сайт ЦБ отдает в windows-1251
		ТекстXML = Ответ.ПолучитьТелоКакСтроку(КодировкаТекста.ANSI);
		
		// Парсим XML
		ЧтениеXML = Новый ЧтениеXML;
		ЧтениеXML.УстановитьСтроку(ТекстXML);
		
		ПостроительDOM = Новый ПостроительDOM;
		ДокументDOM = ПостроительDOM.Прочитать(ЧтениеXML);
		
		// Ищем USD (код 840)
		Курс = 0;
		ЭлементыValute = ДокументDOM.ПолучитьЭлементыПоИмени("Valute");
		Для Каждого Valute Из ЭлементыValute Цикл
			CharCode = Valute.ПолучитьЭлементыПоИмени("CharCode")[0].ТекстовоеСодержимое;
			Если CharCode = "USD" Тогда
				СтрКурс = Valute.ПолучитьЭлементыПоИмени("Value")[0].ТекстовоеСодержимое;
				// Преобразуем 77,6502 -> 77.6502
				Курс = Число(СтрЗаменить(СтрКурс, ",", "."));
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Возврат Курс;
		
	Исключение
		// Обработка ошибки соединения
		ЗаписьЖурналаРегистрации("КурсЦБ", УровеньЖурналаРегистрации.Ошибка,,, ОписаниеОшибки());
		Возврат 0;
	КонецПопытки;

КонецФункции
#EndRegion


